{# =========================
   é€šç”¨å¡ç‰‡å¤–å£³
   ========================= #}
{% macro card_block(
    title='',
    icon_class='',
    header_right='',
    title_class='fw-bold mb-0 text-dark',
    card_classes='border-0 shadow-sm rounded-4 mb-4',
    body_classes='',
    show_header=True,
    wrap_body=True
) %}
  <div class="card {{ card_classes }}">
    {% if show_header %}
    <div class="card-header bg-white border-0 pt-4 px-4 pb-0 d-flex justify-content-between align-items-center">
      <h6 class="{{ title_class }}">
        {% if icon_class %}
          <i class="bi {{ icon_class }} me-2"></i>
        {% endif %}
        {{ title }}
      </h6>
      {{ header_right|safe }}
    </div>
    {% endif %}

    {% if wrap_body %}
      <div class="card-body {{ body_classes }}">
        {{ caller() }}
      </div>
    {% else %}
      {{ caller() }}
    {% endif %}
  </div>
{% endmacro %}

{# =========================
   é€šç”¨ã€Œè¿”å› + æ ‡é¢˜ã€é¡µå¤´
   ========================= #}
{% macro page_header_back(title, back_url, show_placeholder=True) %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <a
      href="{{ back_url }}"
      class="btn btn-light rounded-circle shadow-sm d-flex align-items-center justify-content-center"
      style="width: 40px; height: 40px;"
    >
      <i class="bi bi-chevron-left"></i>
    </a>
    <div class="fw-bold fs-5">{{ title }}</div>
    {% if show_placeholder %}
      <div style="width: 40px;"></div>
    {% endif %}
  </div>
{% endmacro %}

{# =========================
   æ”¶æ”¯æ˜ç»†ï¼šå•è¡Œè®°å½•
   ========================= #}
{% macro record_row(r) %}
  <tr>
    <td class="ps-4">
      <input
        class="form-check-input"
        type="checkbox"
        name="selected_ids"
        value="{{ r.id }}"
        onchange="updateUI()"
      >
    </td>
    <td>
      <small class="text-muted fw-bold">
        {{ r.ts.strftime("%Y-%m-%d %H:%M") }}
      </small>
    </td>
    <td>
      {% if r.type == 'income' %}
      <span class="badge bg-success-subtle text-success rounded-pill px-3">
        æ”¶å…¥
      </span>
      {% else %}
      <span class="badge bg-secondary-subtle text-secondary rounded-pill px-3">
        æ”¯å‡º
      </span>
      {% endif %}
    </td>
    <td class="fw-bold font-monospace {{ 'text-success' if r.type == 'income' else 'text-dark' }}">
      {{ "+" if r.type == 'income' else "-" }}
      {{ "%.2f"|format(r.amount) }}
    </td>
    <td>
      <span class="badge bg-white text-dark border shadow-sm fw-normal">
        {{ r.category }}
      </span>
    </td>
    <td>
      <small class="text-muted">{{ r.note }}</small>
    </td>
    <td class="text-end pe-4">
      <button
        type="button"
        class="btn btn-sm btn-light text-primary me-1"
        title="ç¼–è¾‘"
        data-id="{{ r.id }}"
        data-amount="{{ r.amount }}"
        data-category="{{ r.category }}"
        data-note="{{ r.note }}"
        onclick="openEditModal(this)"
      >
        <i class="bi bi-pencil-square"></i>
      </button>
      <button
        type="button"
        class="btn btn-sm btn-light text-danger"
        title="åˆ é™¤"
        data-id="{{ r.id }}"
        onclick="triggerSingleDelete(this.dataset.id)"
      >
        <i class="bi bi-trash"></i>
      </button>
    </td>
  </tr>
{% endmacro %}

{# =========================
   æ”¶æ”¯æ˜ç»†ï¼šæ‰€æœ‰å¼¹çª— + éšè—è¡¨å•
   ========================= #}
{% macro records_modals(existing_categories) %}
  <!-- å¯¼å‡ºæˆåŠŸæç¤ºå¼¹çª— -->
  <div class="modal fade" id="exportSuccessModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-body p-4 text-center">
          <div class="mb-3 text-success display-1">
            <i class="bi bi-check-circle-fill"></i>
          </div>
          <h4 class="fw-bold mb-3">å¯¼å‡ºæˆåŠŸï¼</h4>
          <p class="text-muted mb-4">æ–‡ä»¶å·²ä¿å­˜åˆ°æ‚¨çš„æ¡Œé¢ï¼š</p>
          <div
            class="bg-light p-3 rounded-3 mb-4 text-break font-monospace small"
            id="exportPathDisplay"
          >
            ...
          </div>
          <button
            type="button"
            class="btn btn-primary px-5 rounded-pill"
            data-bs-dismiss="modal"
          >
            å¥½çš„
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- å¯¼å…¥è´¦å•å¼¹çª— -->
  <div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">ğŸ“ å¯¼å…¥è´¦å•</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body p-4">
          <div class="alert alert-info small border-0 bg-info-subtle mb-4">
            <strong>æ”¯æŒ Excel (.xlsx) æˆ– CSV æ ¼å¼ã€‚</strong><br>
            è¯·ç¡®ä¿æ–‡ä»¶åŒ…å«ä»¥ä¸‹åˆ—åä¹‹ä¸€ï¼š<br>
            <span class="badge bg-white text-dark border mt-1">æ—¶é—´/æ—¥æœŸ</span>
            <span class="badge bg-white text-dark border mt-1">é‡‘é¢</span>
            <span class="badge bg-white text-dark border mt-1">åˆ†ç±»</span>
            <span class="badge bg-white text-dark border mt-1">
              ç±»å‹(æ”¶å…¥/æ”¯å‡º)
            </span>
          </div>
          <form id="importForm">
            <div class="mb-4">
              <label class="form-label fw-bold">é€‰æ‹©æ–‡ä»¶</label>
              <input
                class="form-control form-control-lg"
                type="file"
                id="importFile"
                name="file"
                accept=".csv, .xlsx, .xls"
              >
            </div>
            <button
              type="button"
              class="btn btn-primary w-100 rounded-pill py-2 fw-bold"
              id="btnStartImport"
              onclick="startImport()"
            >
              <i class="bi bi-upload me-1"></i> å¼€å§‹å¯¼å…¥
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- å¯¼å…¥ç»“æœå¼¹çª— -->
  <div class="modal fade" id="importResultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow rounded-4">
        <div class="modal-body p-4 text-center">
          <div class="mb-3 display-4" id="importIcon"></div>
          <h5 class="fw-bold mb-2" id="importTitle"></h5>
          <p class="text-muted" id="importMsg"></p>
          <button
            type="button"
            class="btn btn-light px-4 rounded-pill"
            onclick="location.reload()"
          >
            åˆ·æ–°åˆ—è¡¨
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘è®°å½•å¼¹çª— -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" action="{{ url_for('main.records_update') }}">
          <div class="modal-header">
            <h5 class="modal-title">ç¼–è¾‘</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="id" id="edit_id">

            <div class="mb-3">
              <label class="form-label">é‡‘é¢</label>
              <input
                type="number"
                step="0.01"
                name="amount"
                id="edit_amount"
                class="form-control"
                required
              >
            </div>

            <div class="mb-3">
              <label class="form-label">ç±»åˆ«</label>
              <input
                type="text"
                list="category_list"
                name="category"
                id="edit_category"
                class="form-control"
                required
              >
              <datalist id="category_list">
                {% for cat in existing_categories %}
                <option value="{{ cat }}"></option>
                {% endfor %}
              </datalist>
            </div>

            <div class="mb-3">
              <label class="form-label">å¤‡æ³¨</label>
              <input
                type="text"
                name="note"
                id="edit_note"
                class="form-control"
              >
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              å–æ¶ˆ
            </button>
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">ç¡®è®¤åˆ é™¤</h5>
        </div>
        <div class="modal-body">
          <p id="deleteModalBody"></p>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            å–æ¶ˆ
          </button>
          <button
            type="button"
            class="btn btn-danger"
            id="confirmDeleteBtn"
          >
            åˆ é™¤
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- å•æ¡åˆ é™¤éšè—è¡¨å• -->
  <form
    id="singleDeleteForm"
    method="post"
    action="{{ url_for('main.records_delete') }}"
    style="display: none;"
  >
    <input type="hidden" name="selected_ids" id="singleDeleteIdInput">
  </form>
{% endmacro %}
