{% extends "layout.html" %}
{% block content %}
  
  {% if is_demo %}
  <div class="alert alert-primary d-flex align-items-center justify-content-between mb-4 shadow-sm border-0 bg-primary bg-opacity-10 text-primary animate__animated animate__fadeInDown">
      <div>
        <i class="bi bi-lightning-charge-fill me-2"></i>
        <strong>è¶…çº§æ¼”ç¤ºæ¨¡å¼</strong>
        å·²ç”Ÿæˆçº¦ 10000 æ¡æ•°æ®ï¼Œè¦†ç›–è¿‘åå¹´æ”¶æ”¯ã€‚
      </div>
      <button type="button" class="btn btn-sm btn-primary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#exitDemoModal">
        é€€å‡ºæ¼”ç¤ºæ¨¡å¼
      </button>
  </div>

  <!-- é€€å‡ºæ¼”ç¤ºæ¨¡å¼ç¡®è®¤å¼¹çª—ï¼ˆæ–‡æ¡ˆæ”¹ä¸ºâ€œæ˜¯å¦é€€å‡ºæ¼”ç¤ºæ¨¡å¼â€ / â€œæ˜¯ / å¦â€ï¼‰ -->
  <div class="modal fade" id="exitDemoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow rounded-4">
        <div class="modal-body p-4 text-center">
          <h5 class="fw-bold mb-3">æ˜¯å¦é€€å‡ºæ¼”ç¤ºæ¨¡å¼ï¼Ÿ</h5>
          <p class="text-muted mb-4">
            é€€å‡ºåå°†æ¸…ç©ºå½“å‰æ¼”ç¤ºæ•°æ®ï¼Œå›åˆ°ç©ºè´¦æœ¬ã€‚
          </p>
          <div class="d-flex justify-content-center gap-2 mt-2">
            <button
              type="button"
              class="btn btn-light px-4"
              data-bs-dismiss="modal"
            >
              å¦
            </button>
            <form method="post" action="{{ url_for('exit_demo') }}">
              <button type="submit" class="btn btn-primary px-4">
                æ˜¯
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row justify-content-center mb-4" data-aos="fade-up">
    <div class="col-12 col-xl-10">
      <div class="card shadow-sm border-0 bg-white rounded-4 overflow-hidden">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
              <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-2"><i class="bi bi-pen-fill"></i></div>
              <h5 class="card-title fw-bold mb-0 text-dark">è®°ä¸€ç¬”</h5>
              <div class="ms-auto text-muted small"><i class="bi bi-keyboard"></i> å¿«æ·é”®: Ctrl+Enter ä¿å­˜</div>
          </div>
          
          <form method="post" action="{{ url_for('records_new') }}" id="recordForm" class="row g-3 align-items-end">
            <input type="hidden" name="category" id="manualCategoryInput">
            <div class="col-3 col-md-2">
              <select name="type" class="form-select bg-light border-0 fw-bold text-center py-2" required>
                <option value="expense">æ”¯å‡º</option>
                <option value="income">æ”¶å…¥</option>
              </select>
            </div>
            <div class="col-9 col-md-3">
              <div class="input-group">
                <span class="input-group-text bg-light border-0 text-muted">Â¥</span>
                <input type="number" step="0.01" min="0" name="amount" class="form-control bg-light border-0 fw-bold py-2" placeholder="0.00" required>
              </div>
            </div>
            <div class="col-12 col-md-5">
              <div class="position-relative">
                <input type="text" name="note" id="noteInput" class="form-control bg-light border-0 ps-5 py-2" placeholder="å¤‡æ³¨ (å¦‚: åˆé¥­ 30ï¼ŒAIè‡ªåŠ¨åˆ†ç±»)">
                <i class="bi bi-magic position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
              </div>
            </div>
            <div class="col-12 col-md-2">
              <button class="btn btn-primary w-100 fw-bold py-2 shadow-sm" type="button" onclick="handleSave()">ä¿å­˜</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-4 justify-content-center">
    <div class="col-12 col-md-5 col-xl-4" data-aos="fade-right" data-aos-delay="100">
      <div class="card h-100 card-hover shadow-sm border-0 rounded-4">
        <div class="card-header bg-white border-0 pt-4 pb-0 d-flex justify-content-between align-items-center">
            <h6 class="fw-bold mb-0 text-secondary" id="summaryTitle">æœ¬æœˆæ¦‚å†µ</h6>
            <div class="d-flex align-items-center bg-light rounded-pill p-1">
                <button class="btn btn-sm btn-light rounded-circle border-0" onclick="changeMonth(-1)"><i class="bi bi-chevron-left"></i></button>
                <span class="mx-2 small fw-bold user-select-none" id="currentMonthDisplay">...</span>
                <button class="btn btn-sm btn-light rounded-circle border-0" onclick="changeMonth(1)"><i class="bi bi-chevron-right"></i></button>
            </div>
        </div>
        
        <div class="card-body text-center d-flex flex-column align-items-center">
            <div class="py-2 w-100">
                <small class="text-muted text-uppercase fw-bold ls-1">æ€»æ”¯å‡º</small>
                <h2 class="display-5 fw-bold text-dark mt-1 mb-2" id="sum-spent">--</h2>
                <span class="badge bg-light text-dark border rounded-pill px-3">
                    é¢„ç®—: <span id="sum-budget">--</span>
                </span>
                <div class="mt-2" id="sum-status" onclick="quickSetBudget()"></div>
                
                <div class="mt-4">
                    <a href="{{ url_for('records_page') }}" class="btn btn-sm btn-outline-primary rounded-pill px-4 fw-bold border-2 hover-shadow">
                        <i class="bi bi-receipt-cutoff me-1"></i> æ”¶æ”¯æ˜ç»†
                    </a>
                </div>
            </div>
            
            <div id="pie" style="height:180px; width:100%;" class="mt-2"></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-7 col-xl-6" data-aos="fade-left" data-aos-delay="200">
        <div class="card h-100 card-hover shadow-sm border-0 rounded-4">
            <div class="card-header bg-white border-0 pt-4 pb-0 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0 text-primary"><i class="bi bi-graph-up me-2"></i>æ”¯å‡ºè¶‹åŠ¿</h6>
                <div class="btn-group btn-group-sm bg-light rounded-pill p-1" role="group">
                    <input type="radio" class="btn-check" name="trendMode" id="modeMonth" autocomplete="off" checked onchange="refreshAllCharts()">
                    <label class="btn btn-sm rounded-pill border-0 fw-bold px-3 transition-btn" for="modeMonth">æŒ‰å¤©</label>
                    <input type="radio" class="btn-check" name="trendMode" id="modeYear" autocomplete="off" onchange="refreshAllCharts()">
                    <label class="btn btn-sm rounded-pill border-0 fw-bold px-3 transition-btn" for="modeYear">æŒ‰æœˆ</label>
                </div>
            </div>
            <div class="card-body">
                <div id="trendChart" style="height:300px; width:100%;"></div>
            </div>
        </div>
    </div>
  </div>

  <div class="row justify-content-center" data-aos="fade-up" data-aos-delay="300">
      <div class="col-12 col-xl-10">
          <div class="card shadow-sm border-0 rounded-4">
              <div class="card-header bg-white border-0 pt-4 pb-2 d-flex justify-content-between align-items-center">
                  <h6 class="fw-bold mb-0 text-dark"><i class="bi bi-clock-history me-2"></i>æœ€è¿‘è®°å½•</h6>
              </div>
              <div class="card-body p-0">
                  <div class="table-responsive">
                      <table class="table table-hover align-middle mb-0">
                          <thead class="bg-light text-muted small text-uppercase">
                            <tr>
                              <th class="ps-4">æ—¶é—´</th>
                              <th>ç±»åˆ«</th>
                              <th>å¤‡æ³¨</th>
                              <th class="text-end pe-4">é‡‘é¢</th>
                            </tr>
                          </thead>
                          <tbody>
                              {% for r in recent_records %}
                              <tr>
                                  <td class="ps-4 text-muted small">{{ r.ts.strftime("%m-%d %H:%M") }}</td>
                                  <td><span class="badge bg-white text-dark border fw-normal">{{ r.category }}</span></td>
                                  <td>
                                    {{ r.note }}
                                    {% if r.type == 'income' %}
                                      <span class="badge bg-success-subtle text-success ms-2" style="font-size: 0.7em;">æ”¶å…¥</span>
                                    {% endif %}
                                  </td>
                                  <td class="text-end pe-4 fw-bold {{ 'text-success' if r.type == 'income' else 'text-dark' }}">
                                    {{ "+" if r.type == 'income' else "-" }} {{ "%.2f"|format(r.amount) }}
                                  </td>
                              </tr>
                              {% else %}
                              <tr>
                                <td colspan="4" class="text-center py-4 text-muted">æš‚æ— è®°å½•ï¼Œå¿«å»è®°ä¸€ç¬”å§ï¼</td>
                              </tr>
                              {% endfor %}
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <div class="modal fade" id="categoryConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 border-0 shadow">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold">ğŸ¤– è¿™æ˜¯ä¸€ä¸ªæ–°è¯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body pt-0">
          <p class="text-muted mb-3">AI è¿˜ä¸è®¤è¯†è¿™ä¸ªå¤‡æ³¨ï¼Œè¯·å¸®å®ƒå½’ç±»ï¼š</p>
          <input type="text" list="cat_suggestions" id="confirm_category_input" class="form-control form-control-lg bg-light border-0" placeholder="ä¾‹å¦‚: é¤é¥®...">
          <datalist id="cat_suggestions">
            {% for cat in existing_categories %}
              <option value="{{ cat }}">
            {% endfor %}
              <option value="é¤é¥®">
              <option value="äº¤é€š">
          </datalist>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-primary w-100 rounded-pill" onclick="confirmAndSubmit()">ç¡®è®¤å¹¶å­¦ä¹ </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="setBudgetModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content border-0 shadow rounded-4">
        <div class="modal-header border-0 pb-0">
          <h6 class="modal-title fw-bold">ğŸ’° è®¾ç½®æœˆåº¦é¢„ç®—</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
            <span class="input-group-text bg-light border-0">Â¥</span>
            <input type="number" id="quickBudgetInput" class="form-control bg-light border-0 fw-bold" placeholder="0.00">
          </div>
          <button type="button" class="btn btn-primary w-100 rounded-pill" onclick="submitQuickBudget()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  {% if is_demo %}
  <div class="modal fade" id="demoWelcomeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-body text-center p-5">
          <i class="bi bi-stars text-warning display-1 mb-3"></i>
          <h3 class="fw-bold mb-3">æ¬¢è¿ä½“éªŒ</h3>
          <p class="text-muted mb-4">
            ä¸ºäº†æ–¹ä¾¿æ‚¨æµ‹è¯•ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨ç”Ÿæˆäº†è¦†ç›–è¿‘åå¹´çš„é«˜ä»¿çœŸæ¼”ç¤ºè´¦å•ã€‚
            æ‚¨å¯ä»¥éšæ„æ“ä½œï¼Œä½“éªŒåœ¨<strong>å¤§æ•°æ®é‡</strong>ä¸‹çš„åˆ†é¡µå’Œå›¾è¡¨æ€§èƒ½ã€‚
          </p>
          <button type="button" class="btn btn-primary px-5 rounded-pill" data-bs-dismiss="modal">
            å¼€å§‹æ¢ç´¢
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <style>
      .btn-check:checked + .btn { background-color: white; color: var(--bs-primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
      .transition-btn { transition: all 0.2s ease; }
      #sum-status { transition: transform 0.2s ease; }
      #sum-status:hover { transform: scale(1.05); }
      .hover-shadow:hover { box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important; transform: translateY(-1px); }
  </style>

  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <script>
    let currentDate = new Date();

    function formatDateForApi(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }

    function updateDateDisplay() {
      const y = currentDate.getFullYear();
      const m = currentDate.getMonth() + 1;
      document.getElementById('currentMonthDisplay').textContent = `${y}å¹´${m}æœˆ`;
      document.getElementById('summaryTitle').textContent = `${m}æœˆæ¦‚å†µ`;
    }

    function changeMonth(delta) {
      currentDate.setMonth(currentDate.getMonth() + delta);
      updateDateDisplay();
      refreshAllCharts();
    }

    function refreshAllCharts() {
      const dateStr = formatDateForApi(currentDate);
      const mode = document.getElementById('modeYear').checked ? 'year' : 'month';
      loadSummary(dateStr);
      loadPie(dateStr);
      loadTrend(dateStr, mode);
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateDateDisplay();
        refreshAllCharts();

        const socket = io();
        socket.on("update_pie", () => {
          refreshAllCharts();
        });

        document.addEventListener('keydown', function(e) {
          if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            document.getElementById('noteInput').focus();
          }
          if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            handleSave();
          }
        });

        const demoModalEl = document.getElementById('demoWelcomeModal');
        if (demoModalEl && !sessionStorage.getItem('demoShown')) {
          new bootstrap.Modal(demoModalEl).show();
          sessionStorage.setItem('demoShown', 'true');
        }
    });

    async function handleSave() {
      const form = document.getElementById('recordForm');
      const note = document.getElementById('noteInput').value;
      const type = form.querySelector('select[name="type"]').value;

      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      if (type === 'income' || !note.trim()) {
        form.submit();
        return;
      }

      try {
        const res = await fetch("{{ url_for('api_predict') }}", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({note: note})
        });
        const data = await res.json();

        if (data.category === "å…¶ä»–") {
          new bootstrap.Modal(document.getElementById('categoryConfirmModal')).show();
        } else {
          form.submit();
        }
      } catch(e) {
        form.submit();
      }
    }

    function confirmAndSubmit() {
      document.getElementById('manualCategoryInput').value = document.getElementById('confirm_category_input').value;
      document.getElementById('recordForm').submit();
    }

    function quickSetBudget() {
      new bootstrap.Modal(document.getElementById('setBudgetModal')).show();
    }

    async function submitQuickBudget() {
        const val = document.getElementById('quickBudgetInput').value;
        if (!val) return;
        try {
          const res = await fetch("{{ url_for('api_update_budget') }}", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({budget: val})
          });
          const data = await res.json();
          if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('setBudgetModal')).hide();
            refreshAllCharts();
          }
        } catch(e) {
          alert("è®¾ç½®å¤±è´¥");
        }
    }

    async function loadSummary(dateStr) { 
        const res = await fetch(`{{ url_for('api_summary') }}?date=${dateStr}&t=${Date.now()}`); 
        const data = await res.json(); 
        document.getElementById('sum-spent').textContent = "Â¥" + data.display_spent; 
        document.getElementById('sum-budget').textContent = "Â¥" + data.display_budget; 
        const statusEl = document.getElementById('sum-status');
        statusEl.innerHTML = `<span class="${data.status_class} px-3 py-2 rounded-pill shadow-sm cursor-pointer user-select-none">${data.status_text}</span>`;
        statusEl.style.cursor = data.status_text.includes("æœªè®¾") ? "pointer" : "default";
    }
    
    async function loadPie(dateStr) {
      const el = document.getElementById('pie');
      if(!el) return;
      const res = await fetch(`{{ url_for('api_stats_category') }}?date=${dateStr}&t=${Date.now()}`);
      const data = await res.json();
      const chart = echarts.init(el);
      chart.setOption({
        tooltip:{trigger:'item'},
        series:[{
          type:'pie',
          radius:['50%', '80%'],
          avoidLabelOverlap:false,
          itemStyle: {
            borderRadius: 5,
            borderColor: '#fff',
            borderWidth: 2
          },
          label:{show:false},
          data: data.length ? data : [{value:1, name:'æ— æ•°æ®', itemStyle:{color:'#eee'}}]
        }]
      });
    }

    let trendChartInstance = null;

    async function loadTrend(dateStr, mode) {
      const el = document.getElementById('trendChart');
      if(!el) return;
      const res = await fetch(`{{ url_for('api_stats_trend') }}?date=${dateStr}&mode=${mode}&t=${Date.now()}`);
      const data = await res.json();

      if(trendChartInstance) trendChartInstance.dispose();
      trendChartInstance = echarts.init(el);
      const color = mode === 'month' ? '#4e73df' : '#1cc88a';

      trendChartInstance.setOption({
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(255,255,255,0.9)',
          borderColor: '#eee',
          textStyle: {color:'#333'}
        },
        grid: {
          top: '10%',
          left: '2%',
          right: '3%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: data.labels,
          axisLine:{show:false},
          axisTick:{show:false}
        },
        yAxis: {
          type: 'value',
          splitLine:{lineStyle:{type:'dashed', color:'#f0f0f0'}}
        },
        series: [{
          name: 'æ”¯å‡º',
          type: 'line',
          smooth: true,
          showSymbol: false,
          itemStyle: {color: color},
          areaStyle: {
            color: new echarts.graphic.LinearGradient(0,0,0,1, [
              {offset:0, color:color},
              {offset:1, color:'rgba(255,255,255,0)'}
            ])
          },
          data: data.values
        }]
      });

      window.addEventListener('resize', () => trendChartInstance.resize());
    }
  </script>
{% endblock %}
